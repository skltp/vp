<?xml version="1.0" encoding="utf-8"?>
<!--

    Copyright (c) 2013 Center for eHalsa i samverkan (CeHis).
    							<http://cehis.se/>

    This file is part of SKLTP.

    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Lesser General Public
    License as published by the Free Software Foundation; either
    version 2.1 of the License, or (at your option) any later version.

    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this library; if not, write to the Free Software
    Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

-->
<mule
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:spring="http://www.springframework.org/schema/beans"
  xmlns:https="http://www.mulesoft.org/schema/mule/https"
  xmlns:http="http://www.mulesoft.org/schema/mule/http"
  xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
  xmlns:management="http://www.mulesoft.org/schema/mule/management"
  xsi:schemaLocation="
		http://www.springframework.org/schema/beans		http://www.springframework.org/schema/beans/spring-beans-current.xsd
		http://www.mulesoft.org/schema/mule/core		http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/https		http://www.mulesoft.org/schema/mule/https/current/mule-https.xsd
		http://www.mulesoft.org/schema/mule/jms			http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd
		http://www.mulesoft.org/schema/mule/management	http://www.mulesoft.org/schema/mule/management/current/mule-management.xsd
		http://www.mulesoft.org/schema/mule/http		http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
	">

  <spring:bean id="propertyPlaceholder"
    class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <!--<spring:property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE"/>-->
    <spring:property name="ignoreResourceNotFound" value="true"/>
    <!--<spring:property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDEs"/>-->
    <spring:property name="locations">
      <spring:list>
        <spring:value>classpath:vp-security.properties</spring:value>
        <spring:value>classpath:vp-security-override.properties</spring:value>

        <spring:value>classpath:vp-config.properties</spring:value>
        <spring:value>classpath:vp-messages.properties</spring:value>
        <spring:value>classpath:vp-config-override.properties</spring:value>

        <spring:value>classpath:vp-build.properties</spring:value>
      </spring:list>
    </spring:property>
  </spring:bean>

  <!--
      <management:jmx-default-config port="${JMX_PORT}" registerMx4jAdapter="false" >
          <management:credentials>
              <spring:entry key="${JMX_USER}" value="${JMX_PWD}"/>
          </management:credentials>
      </management:jmx-default-config>
   -->

  <!--  Allow tests to register dynamic listeners by specifying dynamic="true" -->
  <!-- TODO: Is there a performance hit with this that is not acceptable in runtime?
             Then we maybe need a teststub-common-xml file in the end... -->

  <notifications dynamic="true">
    <notification event="COMPONENT-MESSAGE"/>
    <notification event="ENDPOINT-MESSAGE"/>
    <notification event="CONTEXT"/>
    <notification-listener ref="muleStartupNotification"/>
  </notifications>

  <!-- The default profile used by normal usage of mule-app, either deployed in mule or started using st-muleServer-helper-class. Not used by integration tests -->
  <spring:beans profile="default">
    <!-- Connectors et al that are specific for different environment specific config-files (local unit-test, integration-test or production environments) -->

    <!-- TODO: Add import of environment specific configuration files here as required -->

    <!-- Import the JMS-provider used in production here, embedded JMS providers used for integration tests are loaded by the *IntegratIonTest.java classes directly -->

  </spring:beans>

  <!-- Used by integration tests only -->
  <spring:beans profile="soitoolkit-integrationtests">
    <mule>
      <!--  Allow integration tests to register dynamic listeners by specifying dynamic="true" -->
      <!--
      <notifications dynamic="true">
        <notification event="ENDPOINT-MESSAGE"/>
        <notification event="COMPONENT-MESSAGE"/>
      </notifications>
      -->
    </mule>
  </spring:beans>

  <spring:beans>
    <spring:import resource="classpath:vp-mule-http-consumer-connector.xml"/>
    <spring:import resource="classpath:vp-mule-https-consumer-connector.xml"/>
    <spring:import resource="classpath:vp-mule-https-consumer-keepalive-connector.xml"/>
    <spring:import resource="classpath:vp-mule-https-producer-connector.xml"/>

    <spring:bean name="hsaCache" class="se.skl.tp.hsa.cache.HsaCacheImpl"/>

    <spring:bean name="takService" class="se.skltp.takcache.services.TakServiceImpl">
      <spring:constructor-arg index="0" value="${TP_SOKVAGVALSINFO_URL}"/>
      <spring:constructor-arg index="1" value="${takcache.header.user.agent}"/>
    </spring:bean>

    <spring:bean name="takCache" class="se.skltp.takcache.TakCacheImpl">
      <spring:constructor-arg index="0" ref="takService"/>
    </spring:bean>

    <spring:bean name="DeprecatedDefaultRoutingConfiguration" class="se.skl.tp.DefaultRoutingConfigurationImpl">
      <spring:property name="delimiter" value="${DEPRECATED_DEAFAULT_ROUTING_DELIMITER}"/>
      <spring:property name="allowedContractsAsString" value="${DEPRECATED_DEFAULT_ROUTING_CONTRACTS:''}"/>
      <spring:property name="allowedSenderIdsAsString" value="${DEPRECATED_DEFAULT_ROUTING_SENDERS:''}"/>
    </spring:bean>

    <spring:bean name="vagvalAgent" class="se.skl.tp.vp.vagvalagent.VagvalAgent">
      <spring:constructor-arg index="0" ref="hsaCache"/>
      <spring:constructor-arg index="1" ref="takCache"/>
      <spring:constructor-arg index="2" ref="DeprecatedDefaultRoutingConfiguration"/>

      <spring:property name="messageProperties" ref="messageProperties"/>

    </spring:bean>

    <spring:bean name="muleStartupNotification"
      class="se.skl.tp.vp.vagvalagent.MuleStartupNotificationHandler">
      <spring:property name="vagvalAgent" ref="vagvalAgent"/>
      <spring:property name="hsaCache" ref="hsaCache"/>
      <spring:property name="hsaFiles" value="${HSA_FILES}"/>
    </spring:bean>

    <spring:bean name="whiteListHandler" class="se.skl.tp.vp.util.WhiteListHandler">
      <spring:property name="whiteList" value="${IP_WHITE_LIST}"/>
    </spring:bean>

    <spring:bean name="messageProperties" class="se.skl.tp.vp.util.MessageProperties">
      <spring:property name="propertyMap">
        <spring:map>
          <spring:entry key="VP001" value="${VP001}"/>
          <spring:entry key="VP002" value="${VP002}"/>
          <spring:entry key="VP003" value="${VP003}"/>
          <spring:entry key="VP004" value="${VP004}"/>
          <spring:entry key="VP005" value="${VP005}"/>
          <spring:entry key="VP006" value="${VP006}"/>
          <spring:entry key="VP007" value="${VP007}"/>
          <spring:entry key="VP008" value="${VP008}"/>
          <spring:entry key="VP009" value="${VP009}"/>
          <spring:entry key="VP010" value="${VP010}"/>
          <spring:entry key="VP011" value="${VP011}"/>
          <spring:entry key="VP012" value="${VP012}"/>
        </spring:map>
      </spring:property>
    </spring:bean>


  </spring:beans>

  <configuration>
    <default-dispatcher-threading-profile poolExhaustedAction="ABORT"
      maxThreadsActive="${TP_DISPATCH_MAX_THREADS_ACTIVE}"
      maxThreadsIdle="${TP_DISPATCH_MAX_THREADS_IDLE}" threadTTL="${TP_DISPATCH_MAX_THREADS_TTL}"/>
    <default-receiver-threading-profile poolExhaustedAction="ABORT"
      maxThreadsActive="${TP_RECEIVE_MAX_THREADS_ACTIVE}"
      maxThreadsIdle="${TP_RECEIVE_MAX_THREADS_IDLE}" threadTTL="${TP_RECEIVE_MAX_THREADS_TTL}"/>
  </configuration>

  <!-- doc:name="Check SenderId exist in incoming http request, put in session variable" -->
  <custom-transformer name="checkSenderIdTransformer"
    class="se.skl.tp.vp.vagvalrouter.CheckSenderIdTransformer">
    <spring:property name="senderIdPropertyName" value="${VAGVALROUTER_SENDERID}"/>
    <spring:property name="whiteListHandler" ref="whiteListHandler"/>
    <spring:property name="vpInstanceId" value="${VP_INSTANCE_ID}"/>
    <spring:property name="senderIpAdressHttpHeader"
      value="${VAGVALROUTER_SENDER_IP_ADRESS_HTTP_HEADER}"/>
  </custom-transformer>

  <custom-transformer name="wsdlQueryResponse"
    class="se.skl.tp.vp.util.wsdl.WsdlQueryReferencedUrlsResponseTransformer">
    <spring:property name="httpHeaderNameForwardedProto"
      value="${VP_HTTP_HEADER_NAME_FORWARDED_PROTO}"/>
    <spring:property name="httpHeaderNameForwardedHost"
      value="${VP_HTTP_HEADER_NAME_FORWARDED_HOST}"/>
    <spring:property name="httpHeaderNameForwardedPort"
      value="${VP_HTTP_HEADER_NAME_FORWARDED_PORT}"/>
  </custom-transformer>

  <custom-transformer name="featureKeepAliveResponse"
    class="se.skl.tp.vp.feature.keepalive.KeepAliveResponseTransformer"/>

  <custom-transformer name="rivExtractor" class="se.skl.tp.vp.vagvalrouter.RivExtractor"/>


  <!-- #MULE-370, see comment below.
  <custom-transformer name="XmlToXSR" class="org.mule.module.xml.transformer.XmlToXMLStreamReader">
       <spring:property name="reversible" value="true"/>
  </custom-transformer>
  -->
  <!-- #MULE-370
    Mule-3.7.0: workaround for bugs: MULE-8913, MULE-8508:
        The transformer XmlToXMLStreamReader_BugfixedForMule370 will
        be applied (using autodiscovery) for cases where the payload is not an
        XMLStreamReader - but need to be.

        NO OTHER XmlToXMLStreamReader transformer may be declared globally.
        This transformer may also NOT BE REFERENCED BY NAME - or Mule-3.7.0
        will fail saying it found more than one applicable transformer when
        trying to autodiscover and apply this transformer (MULE-8913).

        If an XmlToXMLStreamReader transformer is needed explicitly in a flow,
        it may be declared inline in the flow without using a name.
  -->
  <custom-transformer name="MULE_370_BUG_WORKAROUND_FOR_MULE_BUGS_8913_8508"
    class="se.skl.tp.vp.mule.bugfix.XmlToXMLStreamReader_BugfixedForMule370">
    <spring:property name="reversible" value="true"/>
  </custom-transformer>

  <custom-transformer name="objToStr"
    class="org.soitoolkit.commons.mule.core.ObjectToStringTransformer"/>

  <custom-transformer name="createCorrId"
    class="org.soitoolkit.commons.mule.log.correlationid.CreateCorrelationIdTransformer"/>

  <custom-transformer name="objToXml"
    class="org.soitoolkit.commons.mule.jaxb.JaxbObjectToXmlTransformer">
    <spring:property name="contextPath"
      value="org.w3.wsaddressing10:se.riv.itintegration.monitoring.v1"/>
  </custom-transformer>

  <custom-transformer name="xmlToObj"
    class="org.soitoolkit.commons.mule.jaxb.XmlToJaxbObjectTransformer">
    <spring:property name="contextPath"
      value="org.w3.wsaddressing10:se.riv.itintegration.monitoring.v1"/>
  </custom-transformer>

  <custom-transformer name="rivTransformer" class="se.skl.tp.vp.vagvalrouter.RivTransformer">
    <!-- Value for HTTP header x-vp-instance-id -->
    <spring:property name="vpInstanceId" value="${VP_INSTANCE_ID}"/>
    <spring:property name="vagvalAgent" ref="vagvalAgent"/>
  </custom-transformer>

  <custom-transformer name="exceptionTransformer"
    class="se.skl.tp.vp.vagvalrouter.ExceptionTransformer"/>
  <!-- 	<custom-transformer name="createSoapFaultIfException" class="org.soitoolkit.commons.mule.soap.CreateSoapFaultIfExceptionTransformer"/> -->

  <custom-transformer name="mimeToStr"
    class="org.soitoolkit.commons.mule.mime.MimeToStringTransformer"/>

  <custom-transformer name="logReqIn" class="se.skl.tp.vp.logging.LogTransformer">
    <spring:property name="enableLogToJms" value="${ENABLE_LOG_TO_JMS}"/>
    <spring:property name="logType" value="xreq-in"/>
    <spring:property name="jaxbObjectToXml" ref="objToXml"/>
    <spring:property name="logInfoQueueName" value="${SOITOOLKIT_LOG_INFO_QUEUE}"/>
    <spring:property name="logErrorQueueName" value="${SOITOOLKIT_LOG_ERROR_QUEUE}"/>
    <spring:property name="useSocketLogger" value="${USE_SOCKET_LOGGER}"/>
    <spring:property name="socketLoggerCategories" value="${SOCKET_LOGGER_CATEGORIES}"/>
    <spring:property name="socketLoggerServiceContracts"
      value="${SOCKET_LOGGER_SERVICE_CONTRACTS}"/>
  </custom-transformer>

  <custom-transformer name="logReqOut" class="se.skl.tp.vp.logging.LogTransformer">
    <spring:property name="enableLogToJms" value="${ENABLE_LOG_TO_JMS}"/>
    <spring:property name="logType" value="xreq-out"/>
    <spring:property name="jaxbObjectToXml" ref="objToXml"/>
    <spring:property name="logInfoQueueName" value="${SOITOOLKIT_LOG_INFO_QUEUE}"/>
    <spring:property name="logErrorQueueName" value="${SOITOOLKIT_LOG_ERROR_QUEUE}"/>
    <spring:property name="useSocketLogger" value="${USE_SOCKET_LOGGER}"/>
    <spring:property name="socketLoggerCategories" value="${SOCKET_LOGGER_CATEGORIES}"/>
    <spring:property name="socketLoggerServiceContracts"
      value="${SOCKET_LOGGER_SERVICE_CONTRACTS}"/>
  </custom-transformer>

  <custom-transformer name="logRespIn" class="se.skl.tp.vp.logging.LogTransformer">
    <spring:property name="enableLogToJms" value="${ENABLE_LOG_TO_JMS}"/>
    <spring:property name="logType" value="xresp-in"/>
    <spring:property name="jaxbObjectToXml" ref="objToXml"/>
    <spring:property name="logInfoQueueName" value="${SOITOOLKIT_LOG_INFO_QUEUE}"/>
    <spring:property name="logErrorQueueName" value="${SOITOOLKIT_LOG_ERROR_QUEUE}"/>
    <spring:property name="useSocketLogger" value="${USE_SOCKET_LOGGER}"/>
    <spring:property name="socketLoggerCategories" value="${SOCKET_LOGGER_CATEGORIES}"/>
    <spring:property name="socketLoggerServiceContracts"
      value="${SOCKET_LOGGER_SERVICE_CONTRACTS}"/>
  </custom-transformer>

  <custom-transformer name="logRespOut" class="se.skl.tp.vp.logging.LogTransformer">
    <spring:property name="enableLogToJms" value="${ENABLE_LOG_TO_JMS}"/>
    <spring:property name="logType" value="xresp-out"/>
    <spring:property name="jaxbObjectToXml" ref="objToXml"/>
    <spring:property name="logInfoQueueName" value="${SOITOOLKIT_LOG_INFO_QUEUE}"/>
    <spring:property name="logErrorQueueName" value="${SOITOOLKIT_LOG_ERROR_QUEUE}"/>
    <spring:property name="useSocketLogger" value="${USE_SOCKET_LOGGER}"/>
    <spring:property name="socketLoggerCategories" value="${SOCKET_LOGGER_CATEGORIES}"/>
    <spring:property name="socketLoggerServiceContracts"
      value="${SOCKET_LOGGER_SERVICE_CONTRACTS}"/>
  </custom-transformer>

  <message-properties-transformer name="filterResponseHeaders" scope="outbound">
    <delete-message-property key="SOAPAction"/>
    <delete-message-property key="X-MULE_CORRELATION_GROUP_SIZE" />
    <delete-message-property key="X-MULE_CORRELATION_ID" />
    <delete-message-property key="X-MULE_CORRELATION_SEQUENCE" />
    <delete-message-property key="MULE_ENCODING"/>
    <delete-message-property key="http.method"/>
    <delete-message-property key="LOCAL_CERTIFICATES"/>
    <delete-message-property key="PEER_CERTIFICATES"/>
  </message-properties-transformer>


</mule>